<html>
<head>
<title>MockKit.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #aa7dfc;}
.s3 { color: #e2da90;}
.s4 { color: #faa23d;}
.s5 { color: #db7e9b;}
.s6 { color: #b3e54c;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
MockKit.js</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) 2022 Huawei Device Co., Ltd. 
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); 
 * you may not use this file except in compliance with the License. 
 * You may obtain a copy of the License at 
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0 
 * 
 * Unless required by applicable law or agreed to in writing, software 
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, 
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
 * See the License for the specific language governing permissions and 
 * limitations under the License. 
 */</span>

<span class="s1">import ExtendInterface from </span><span class="s2">&quot;./ExtendInterface&quot;</span><span class="s3">;</span>
<span class="s1">import VerificationMode from </span><span class="s2">&quot;./VerificationMode&quot;</span><span class="s3">;</span>
<span class="s1">import ArgumentMatchers from </span><span class="s2">&quot;./ArgumentMatchers&quot;</span><span class="s3">;</span>

<span class="s1">class MockKit </span><span class="s4">{</span>

    <span class="s1">constructor</span><span class="s5">() </span><span class="s4">{</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">mFunctions </span><span class="s3">= </span><span class="s5">[]</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">stubs </span><span class="s3">= </span><span class="s1">new Map</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">recordCalls </span><span class="s3">= </span><span class="s1">new Map</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">currentSetKey </span><span class="s3">= </span><span class="s1">null</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">mockObj </span><span class="s3">= </span><span class="s1">null</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">recordMockedMethod </span><span class="s3">= </span><span class="s1">new Map</span><span class="s5">()</span><span class="s3">;</span>
    <span class="s4">}</span>

    <span class="s1">init</span><span class="s5">() </span><span class="s4">{</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">reset</span><span class="s5">()</span><span class="s3">;</span>
    <span class="s4">}</span>

    <span class="s1">reset</span><span class="s5">() </span><span class="s4">{</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">mFunctions </span><span class="s3">= </span><span class="s5">[]</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">stubs </span><span class="s3">= </span><span class="s4">{}</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">recordCalls </span><span class="s3">= </span><span class="s4">{}</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">currentSetKey </span><span class="s3">= </span><span class="s1">null</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">mockObj </span><span class="s3">= </span><span class="s1">null</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">recordMockedMethod </span><span class="s3">= </span><span class="s1">new Map</span><span class="s5">()</span><span class="s3">;</span>
    <span class="s4">}</span>

    <span class="s1">clearAll</span><span class="s5">() </span><span class="s4">{</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">reset</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s1">var props </span><span class="s3">= </span><span class="s1">Object</span><span class="s3">.</span><span class="s1">keys</span><span class="s5">(</span><span class="s1">this</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">for </span><span class="s5">(</span><span class="s1">var i </span><span class="s3">= </span><span class="s6">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">props</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; </span><span class="s1">i</span><span class="s3">++</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">delete this</span><span class="s5">[</span><span class="s1">props</span><span class="s5">[</span><span class="s1">i</span><span class="s5">]]</span><span class="s3">;</span>
        <span class="s4">}</span>

        <span class="s1">var props </span><span class="s3">= </span><span class="s1">Object</span><span class="s3">.</span><span class="s1">getOwnPropertyNames</span><span class="s5">(</span><span class="s1">this</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">for </span><span class="s5">(</span><span class="s1">var i </span><span class="s3">= </span><span class="s6">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">props</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; </span><span class="s1">i</span><span class="s3">++</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">delete this</span><span class="s5">[</span><span class="s1">props</span><span class="s5">[</span><span class="s1">i</span><span class="s5">]]</span><span class="s3">;</span>
        <span class="s4">}</span>
        <span class="s1">for </span><span class="s5">(</span><span class="s1">var key in this</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">delete this</span><span class="s5">[</span><span class="s1">key</span><span class="s5">]</span><span class="s3">;</span>
        <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s1">clear</span><span class="s5">(</span><span class="s1">obj</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s3">!</span><span class="s1">obj</span><span class="s5">) </span><span class="s1">throw Error</span><span class="s5">(</span><span class="s2">&quot;Please enter an object to be cleaned&quot;</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s1">typeof </span><span class="s5">(</span><span class="s1">obj</span><span class="s5">) </span><span class="s3">!= </span><span class="s2">'object'</span><span class="s5">) </span><span class="s1">throw new Error</span><span class="s5">(</span><span class="s2">'Not a object'</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">recordMockedMethod</span><span class="s3">.</span><span class="s1">forEach</span><span class="s5">(</span><span class="s1">function </span><span class="s5">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">map</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">if </span><span class="s5">(</span><span class="s1">key</span><span class="s5">) </span><span class="s4">{</span>
                <span class="s1">obj</span><span class="s5">[</span><span class="s1">key</span><span class="s5">] </span><span class="s3">= </span><span class="s1">value</span><span class="s3">;</span>
            <span class="s4">}</span>
        <span class="s4">}</span><span class="s5">)</span><span class="s3">;</span>
    <span class="s4">}</span>

    <span class="s1">ignoreMock</span><span class="s5">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">method</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s1">typeof </span><span class="s5">(</span><span class="s1">obj</span><span class="s5">) </span><span class="s3">!= </span><span class="s2">'object'</span><span class="s5">) </span><span class="s1">throw new Error</span><span class="s5">(</span><span class="s2">'Not a object'</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s1">typeof </span><span class="s5">(</span><span class="s1">method</span><span class="s5">) </span><span class="s3">!= </span><span class="s2">'function'</span><span class="s5">) </span><span class="s1">throw new Error</span><span class="s5">(</span><span class="s2">'Not a function'</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">let og </span><span class="s3">= </span><span class="s1">this</span><span class="s3">.</span><span class="s1">recordMockedMethod</span><span class="s3">.</span><span class="s1">get</span><span class="s5">(</span><span class="s1">method</span><span class="s3">.</span><span class="s1">propName</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s1">og</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">obj</span><span class="s5">[</span><span class="s1">method</span><span class="s3">.</span><span class="s1">propName</span><span class="s5">] </span><span class="s3">= </span><span class="s1">og</span><span class="s3">;</span>
            <span class="s1">this</span><span class="s3">.</span><span class="s1">recordMockedMethod</span><span class="s3">.</span><span class="s1">set</span><span class="s5">(</span><span class="s1">method</span><span class="s3">.</span><span class="s1">propName</span><span class="s3">, </span><span class="s1">undefined</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s1">extend</span><span class="s5">(</span><span class="s1">dest</span><span class="s3">, </span><span class="s1">source</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">dest</span><span class="s5">[</span><span class="s2">&quot;stub&quot;</span><span class="s5">] </span><span class="s3">= </span><span class="s1">source</span><span class="s5">[</span><span class="s2">&quot;stub&quot;</span><span class="s5">]</span><span class="s3">;</span>
        <span class="s1">dest</span><span class="s5">[</span><span class="s2">&quot;afterReturn&quot;</span><span class="s5">] </span><span class="s3">= </span><span class="s1">source</span><span class="s5">[</span><span class="s2">&quot;afterReturn&quot;</span><span class="s5">]</span><span class="s3">;</span>
        <span class="s1">dest</span><span class="s5">[</span><span class="s2">&quot;afterReturnNothing&quot;</span><span class="s5">] </span><span class="s3">= </span><span class="s1">source</span><span class="s5">[</span><span class="s2">&quot;afterReturnNothing&quot;</span><span class="s5">]</span><span class="s3">;</span>
        <span class="s1">dest</span><span class="s5">[</span><span class="s2">&quot;afterAction&quot;</span><span class="s5">] </span><span class="s3">= </span><span class="s1">source</span><span class="s5">[</span><span class="s2">&quot;afterAction&quot;</span><span class="s5">]</span><span class="s3">;</span>
        <span class="s1">dest</span><span class="s5">[</span><span class="s2">&quot;afterThrow&quot;</span><span class="s5">] </span><span class="s3">= </span><span class="s1">source</span><span class="s5">[</span><span class="s2">&quot;afterThrow&quot;</span><span class="s5">]</span><span class="s3">;</span>
        <span class="s1">dest</span><span class="s5">[</span><span class="s2">&quot;stubMockedCall&quot;</span><span class="s5">] </span><span class="s3">= </span><span class="s1">source</span><span class="s5">[</span><span class="s2">&quot;stubMockedCall&quot;</span><span class="s5">]</span><span class="s3">;</span>
        <span class="s1">dest</span><span class="s5">[</span><span class="s2">&quot;clear&quot;</span><span class="s5">] </span><span class="s3">= </span><span class="s1">source</span><span class="s5">[</span><span class="s2">&quot;clear&quot;</span><span class="s5">]</span><span class="s3">;</span>
        <span class="s1">return dest</span><span class="s3">;</span>
    <span class="s4">}</span>

    <span class="s1">stubApply</span><span class="s5">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">params</span><span class="s3">, </span><span class="s1">returnInfo</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">let values </span><span class="s3">= </span><span class="s1">this</span><span class="s3">.</span><span class="s1">stubs</span><span class="s3">.</span><span class="s1">get</span><span class="s5">(</span><span class="s1">f</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s3">!</span><span class="s1">values</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">values </span><span class="s3">= </span><span class="s1">new Map</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s4">}</span>
        <span class="s1">let key </span><span class="s3">= </span><span class="s1">params</span><span class="s5">[</span><span class="s6">0</span><span class="s5">]</span><span class="s3">;</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s1">typeof key </span><span class="s3">== </span><span class="s2">&quot;undefined&quot;</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">key </span><span class="s3">= </span><span class="s2">&quot;anonymous-mock-&quot; </span><span class="s3">+ </span><span class="s1">f</span><span class="s3">.</span><span class="s1">propName</span><span class="s3">;</span>
        <span class="s4">}</span>
        <span class="s1">let matcher </span><span class="s3">= </span><span class="s1">new ArgumentMatchers</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s1">matcher</span><span class="s3">.</span><span class="s1">matcheStubKey</span><span class="s5">(</span><span class="s1">key</span><span class="s5">)) </span><span class="s4">{</span>
            <span class="s1">key </span><span class="s3">= </span><span class="s1">matcher</span><span class="s3">.</span><span class="s1">matcheStubKey</span><span class="s5">(</span><span class="s1">key</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">if </span><span class="s5">(</span><span class="s1">key</span><span class="s5">) </span><span class="s4">{</span>
                <span class="s1">this</span><span class="s3">.</span><span class="s1">currentSetKey </span><span class="s3">= </span><span class="s1">key</span><span class="s3">;</span>
            <span class="s4">}</span>
        <span class="s4">}</span>
        <span class="s1">values</span><span class="s3">.</span><span class="s1">set</span><span class="s5">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">returnInfo</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">stubs</span><span class="s3">.</span><span class="s1">set</span><span class="s5">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">values</span><span class="s5">)</span><span class="s3">;</span>
    <span class="s4">}</span>

    <span class="s1">getReturnInfo</span><span class="s5">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">params</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">let values </span><span class="s3">= </span><span class="s1">this</span><span class="s3">.</span><span class="s1">stubs</span><span class="s3">.</span><span class="s1">get</span><span class="s5">(</span><span class="s1">f</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s3">!</span><span class="s1">values</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">return undefined</span><span class="s3">;</span>
        <span class="s4">}</span>
        <span class="s1">let retrunKet </span><span class="s3">= </span><span class="s1">params</span><span class="s5">[</span><span class="s6">0</span><span class="s5">]</span><span class="s3">;</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s1">typeof retrunKet </span><span class="s3">== </span><span class="s2">&quot;undefined&quot;</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">retrunKet </span><span class="s3">= </span><span class="s2">&quot;anonymous-mock-&quot; </span><span class="s3">+ </span><span class="s1">f</span><span class="s3">.</span><span class="s1">propName</span><span class="s3">;</span>
        <span class="s4">}</span>
        <span class="s1">let stubSetKey </span><span class="s3">= </span><span class="s1">this</span><span class="s3">.</span><span class="s1">currentSetKey</span><span class="s3">;</span>

        <span class="s1">if </span><span class="s5">(</span><span class="s1">this</span><span class="s3">.</span><span class="s1">currentSetKey </span><span class="s3">&amp;&amp; </span><span class="s5">(</span><span class="s1">typeof </span><span class="s5">(</span><span class="s1">retrunKet</span><span class="s5">) </span><span class="s3">!= </span><span class="s2">&quot;undefined&quot;</span><span class="s5">)) </span><span class="s4">{</span>
            <span class="s1">retrunKet </span><span class="s3">= </span><span class="s1">stubSetKey</span><span class="s3">;</span>
        <span class="s4">}</span>
        <span class="s1">let matcher </span><span class="s3">= </span><span class="s1">new ArgumentMatchers</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s1">matcher</span><span class="s3">.</span><span class="s1">matcheReturnKey</span><span class="s5">(</span><span class="s1">params</span><span class="s5">[</span><span class="s6">0</span><span class="s5">]</span><span class="s3">, </span><span class="s1">undefined</span><span class="s3">, </span><span class="s1">stubSetKey</span><span class="s5">) </span><span class="s3">&amp;&amp; </span><span class="s1">matcher</span><span class="s3">.</span><span class="s1">matcheReturnKey</span><span class="s5">(</span><span class="s1">params</span><span class="s5">[</span><span class="s6">0</span><span class="s5">]</span><span class="s3">, </span><span class="s1">undefined</span><span class="s3">, </span><span class="s1">stubSetKey</span><span class="s5">) </span><span class="s3">!= </span><span class="s1">stubSetKey</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">retrunKet </span><span class="s3">= </span><span class="s1">params</span><span class="s5">[</span><span class="s6">0</span><span class="s5">]</span><span class="s3">;</span>
        <span class="s4">}</span>

        <span class="s1">values</span><span class="s3">.</span><span class="s1">forEach</span><span class="s5">(</span><span class="s1">function </span><span class="s5">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">map</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">if </span><span class="s5">(</span><span class="s1">ArgumentMatchers</span><span class="s3">.</span><span class="s1">isRegExp</span><span class="s5">(</span><span class="s1">key</span><span class="s5">) </span><span class="s3">&amp;&amp; </span><span class="s1">matcher</span><span class="s3">.</span><span class="s1">matcheReturnKey</span><span class="s5">(</span><span class="s1">params</span><span class="s5">[</span><span class="s6">0</span><span class="s5">]</span><span class="s3">, </span><span class="s1">key</span><span class="s5">)) </span><span class="s4">{</span>
                <span class="s1">retrunKet </span><span class="s3">= </span><span class="s1">key</span><span class="s3">;</span>
            <span class="s4">}</span>
        <span class="s4">}</span><span class="s5">)</span><span class="s3">;</span>

        <span class="s1">return values</span><span class="s3">.</span><span class="s1">get</span><span class="s5">(</span><span class="s1">retrunKet</span><span class="s5">)</span><span class="s3">;</span>
    <span class="s4">}</span>

    <span class="s1">findName</span><span class="s5">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">value</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">let properties </span><span class="s3">= </span><span class="s1">this</span><span class="s3">.</span><span class="s1">findProperties</span><span class="s5">(</span><span class="s1">obj</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">let name </span><span class="s3">= </span><span class="s1">null</span><span class="s3">;</span>
        <span class="s1">properties</span><span class="s3">.</span><span class="s1">forEach</span><span class="s5">(</span>
            <span class="s1">function </span><span class="s5">(</span><span class="s1">va1</span><span class="s3">, </span><span class="s1">idx</span><span class="s3">, </span><span class="s1">array</span><span class="s5">) </span><span class="s4">{</span>
                <span class="s1">if </span><span class="s5">(</span><span class="s1">obj</span><span class="s5">[</span><span class="s1">va1</span><span class="s5">] </span><span class="s3">=== </span><span class="s1">value</span><span class="s5">) </span><span class="s4">{</span>
                    <span class="s1">name </span><span class="s3">= </span><span class="s1">va1</span><span class="s3">;</span>
                <span class="s4">}</span>
            <span class="s4">}</span>
        <span class="s5">)</span><span class="s3">;</span>
        <span class="s1">return name</span><span class="s3">;</span>
    <span class="s4">}</span>

    <span class="s1">isFunctionFromPrototype</span><span class="s5">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">container</span><span class="s3">, </span><span class="s1">propName</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s1">container</span><span class="s3">.</span><span class="s1">constructor </span><span class="s3">!= </span><span class="s1">Object </span><span class="s3">&amp;&amp; </span><span class="s1">container</span><span class="s3">.</span><span class="s1">constructor</span><span class="s3">.</span><span class="s1">prototype </span><span class="s3">!== </span><span class="s1">container</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">return container</span><span class="s3">.</span><span class="s1">constructor</span><span class="s3">.</span><span class="s1">prototype</span><span class="s5">[</span><span class="s1">propName</span><span class="s5">] </span><span class="s3">=== </span><span class="s1">f</span><span class="s3">;</span>
        <span class="s4">}</span>
        <span class="s1">return false</span><span class="s3">;</span>
    <span class="s4">}</span>

    <span class="s1">findProperties</span><span class="s5">(</span><span class="s1">obj</span><span class="s3">, ...</span><span class="s1">arg</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">function getProperty</span><span class="s5">(</span><span class="s1">new_obj</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">if </span><span class="s5">(</span><span class="s1">new_obj</span><span class="s3">.</span><span class="s1">__proto__ </span><span class="s3">=== </span><span class="s1">null</span><span class="s5">) </span><span class="s4">{</span>
                <span class="s1">return </span><span class="s5">[]</span><span class="s3">;</span>
            <span class="s4">}</span>
            <span class="s1">let properties </span><span class="s3">= </span><span class="s1">Object</span><span class="s3">.</span><span class="s1">getOwnPropertyNames</span><span class="s5">(</span><span class="s1">new_obj</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">return </span><span class="s5">[</span><span class="s3">...</span><span class="s1">properties</span><span class="s3">, ...</span><span class="s1">getProperty</span><span class="s5">(</span><span class="s1">new_obj</span><span class="s3">.</span><span class="s1">__proto__</span><span class="s5">)]</span><span class="s3">;</span>
        <span class="s4">}</span>
        <span class="s1">return getProperty</span><span class="s5">(</span><span class="s1">obj</span><span class="s5">)</span><span class="s3">;</span>
    <span class="s4">}</span>

    <span class="s1">recordMethodCall</span><span class="s5">(</span><span class="s1">originalMethod</span><span class="s3">, </span><span class="s1">args</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">Function</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">getName </span><span class="s3">= </span><span class="s1">function </span><span class="s5">() </span><span class="s4">{</span>
            <span class="s1">return this</span><span class="s3">.</span><span class="s1">name </span><span class="s3">|| </span><span class="s1">this</span><span class="s3">.</span><span class="s1">toString</span><span class="s5">()</span><span class="s3">.</span><span class="s1">match</span><span class="s5">(</span><span class="s2">/function\s*([^(]*)\(/</span><span class="s5">)[</span><span class="s6">1</span><span class="s5">]</span><span class="s3">;</span>
        <span class="s4">}</span><span class="s3">;</span>
        <span class="s1">let name </span><span class="s3">= </span><span class="s1">originalMethod</span><span class="s3">.</span><span class="s1">getName</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s1">let arglistString </span><span class="s3">= </span><span class="s1">name </span><span class="s3">+ </span><span class="s2">'(' </span><span class="s3">+ </span><span class="s1">Array</span><span class="s3">.</span><span class="s1">from</span><span class="s5">(</span><span class="s1">args</span><span class="s5">)</span><span class="s3">.</span><span class="s1">toString</span><span class="s5">() </span><span class="s3">+ </span><span class="s2">')'</span><span class="s3">;</span>
        <span class="s1">let records </span><span class="s3">= </span><span class="s1">this</span><span class="s3">.</span><span class="s1">recordCalls</span><span class="s3">.</span><span class="s1">get</span><span class="s5">(</span><span class="s1">arglistString</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s3">!</span><span class="s1">records</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">records </span><span class="s3">= </span><span class="s6">0</span><span class="s3">;</span>
        <span class="s4">}</span>
        <span class="s1">records</span><span class="s3">++;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">recordCalls</span><span class="s3">.</span><span class="s1">set</span><span class="s5">(</span><span class="s1">arglistString</span><span class="s3">, </span><span class="s1">records</span><span class="s5">)</span><span class="s3">;</span>
    <span class="s4">}</span>

    <span class="s1">mockFunc</span><span class="s5">(</span><span class="s1">originalObject</span><span class="s3">, </span><span class="s1">originalMethod</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">let tmp </span><span class="s3">= </span><span class="s1">this</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">originalMethod </span><span class="s3">= </span><span class="s1">originalMethod</span><span class="s3">;</span>
        <span class="s1">let f </span><span class="s3">= </span><span class="s1">function </span><span class="s5">() </span><span class="s4">{</span>
            <span class="s1">let args </span><span class="s3">= </span><span class="s1">arguments</span><span class="s3">;</span>
            <span class="s1">let action </span><span class="s3">= </span><span class="s1">tmp</span><span class="s3">.</span><span class="s1">getReturnInfo</span><span class="s5">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">args</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">if </span><span class="s5">(</span><span class="s1">originalMethod</span><span class="s5">) </span><span class="s4">{</span>
                <span class="s1">tmp</span><span class="s3">.</span><span class="s1">recordMethodCall</span><span class="s5">(</span><span class="s1">originalMethod</span><span class="s3">, </span><span class="s1">args</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s4">}</span>
            <span class="s1">if </span><span class="s5">(</span><span class="s1">action</span><span class="s5">) </span><span class="s4">{</span>
                <span class="s1">return action</span><span class="s3">.</span><span class="s1">apply</span><span class="s5">(</span><span class="s1">this</span><span class="s3">, </span><span class="s1">args</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s4">}</span>
        <span class="s4">}</span><span class="s3">;</span>

        <span class="s1">f</span><span class="s3">.</span><span class="s1">container </span><span class="s3">= </span><span class="s1">null </span><span class="s3">|| </span><span class="s1">originalObject</span><span class="s3">;</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">original </span><span class="s3">= </span><span class="s1">originalMethod </span><span class="s3">|| </span><span class="s1">null</span><span class="s3">;</span>

        <span class="s1">if </span><span class="s5">(</span><span class="s1">originalObject </span><span class="s3">&amp;&amp; </span><span class="s1">originalMethod</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">if </span><span class="s5">(</span><span class="s1">typeof </span><span class="s5">(</span><span class="s1">originalMethod</span><span class="s5">) </span><span class="s3">!= </span><span class="s2">'function'</span><span class="s5">) </span><span class="s1">throw new Error</span><span class="s5">(</span><span class="s2">'Not a function'</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">var name </span><span class="s3">= </span><span class="s1">this</span><span class="s3">.</span><span class="s1">findName</span><span class="s5">(</span><span class="s1">originalObject</span><span class="s3">, </span><span class="s1">originalMethod</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">originalObject</span><span class="s5">[</span><span class="s1">name</span><span class="s5">] </span><span class="s3">= </span><span class="s1">f</span><span class="s3">;</span>
            <span class="s1">this</span><span class="s3">.</span><span class="s1">recordMockedMethod</span><span class="s3">.</span><span class="s1">set</span><span class="s5">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">originalMethod</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">propName </span><span class="s3">= </span><span class="s1">name</span><span class="s3">;</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">originalFromPrototype </span><span class="s3">= </span><span class="s1">this</span><span class="s3">.</span><span class="s1">isFunctionFromPrototype</span><span class="s5">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">original</span><span class="s3">, </span><span class="s1">originalObject</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">propName</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s4">}</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">mocker </span><span class="s3">= </span><span class="s1">this</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">mFunctions</span><span class="s3">.</span><span class="s1">push</span><span class="s5">(</span><span class="s1">f</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">this</span><span class="s3">.</span><span class="s1">extend</span><span class="s5">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">new ExtendInterface</span><span class="s5">(</span><span class="s1">this</span><span class="s5">))</span><span class="s3">;</span>
        <span class="s1">return f</span><span class="s3">;</span>
    <span class="s4">}</span>

    <span class="s1">verify</span><span class="s5">(</span><span class="s1">methodName</span><span class="s3">, </span><span class="s1">argsArray</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s3">!</span><span class="s1">methodName</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">throw Error</span><span class="s5">(</span><span class="s2">&quot;not a function name&quot;</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s4">}</span>
        <span class="s1">let a </span><span class="s3">= </span><span class="s1">this</span><span class="s3">.</span><span class="s1">recordCalls</span><span class="s3">.</span><span class="s1">get</span><span class="s5">(</span><span class="s1">methodName </span><span class="s3">+ </span><span class="s2">'(' </span><span class="s3">+ </span><span class="s1">argsArray</span><span class="s3">.</span><span class="s1">toString</span><span class="s5">() </span><span class="s3">+ </span><span class="s2">')'</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">return new VerificationMode</span><span class="s5">(</span><span class="s1">a </span><span class="s3">? </span><span class="s1">a </span><span class="s3">: </span><span class="s6">0</span><span class="s5">)</span><span class="s3">;</span>
    <span class="s4">}</span>

    <span class="s1">mockObject</span><span class="s5">(</span><span class="s1">object</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">if </span><span class="s5">(</span><span class="s3">!</span><span class="s1">object </span><span class="s3">|| </span><span class="s1">typeof object </span><span class="s3">=== </span><span class="s2">&quot;string&quot;</span><span class="s5">) </span><span class="s4">{</span>
            <span class="s1">throw Error</span><span class="s5">(</span><span class="s2">`this </span><span class="s4">${</span><span class="s1">object</span><span class="s4">} </span><span class="s2">cannot be mocked`</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s4">}</span>
        <span class="s1">const _this </span><span class="s3">= </span><span class="s1">this</span><span class="s3">;</span>
        <span class="s1">let mockedObject </span><span class="s3">= </span><span class="s4">{}</span><span class="s3">;</span>
        <span class="s1">let keys </span><span class="s3">= </span><span class="s1">Reflect</span><span class="s3">.</span><span class="s1">ownKeys</span><span class="s5">(</span><span class="s1">object</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">keys</span><span class="s3">.</span><span class="s1">filter</span><span class="s5">(</span><span class="s1">key </span><span class="s3">=&gt; </span><span class="s5">(</span><span class="s1">typeof Reflect</span><span class="s3">.</span><span class="s1">get</span><span class="s5">(</span><span class="s1">object</span><span class="s3">, </span><span class="s1">key</span><span class="s5">)) </span><span class="s3">=== </span><span class="s2">'function'</span><span class="s5">)</span>
            <span class="s3">.</span><span class="s1">forEach</span><span class="s5">(</span><span class="s1">key </span><span class="s3">=&gt; </span><span class="s4">{</span>
                <span class="s1">mockedObject</span><span class="s5">[</span><span class="s1">key</span><span class="s5">] </span><span class="s3">= </span><span class="s1">object</span><span class="s5">[</span><span class="s1">key</span><span class="s5">]</span><span class="s3">;</span>
                <span class="s1">mockedObject</span><span class="s5">[</span><span class="s1">key</span><span class="s5">] </span><span class="s3">= </span><span class="s1">_this</span><span class="s3">.</span><span class="s1">mockFunc</span><span class="s5">(</span><span class="s1">mockedObject</span><span class="s3">, </span><span class="s1">mockedObject</span><span class="s5">[</span><span class="s1">key</span><span class="s5">])</span><span class="s3">;</span>
            <span class="s4">}</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s1">return mockedObject</span><span class="s3">;</span>
    <span class="s4">}</span>
<span class="s4">}</span>

<span class="s1">function ifMockedFunction</span><span class="s5">(</span><span class="s1">f</span><span class="s5">) </span><span class="s4">{</span>
    <span class="s1">if </span><span class="s5">(</span><span class="s1">Object</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">toString</span><span class="s3">.</span><span class="s1">call</span><span class="s5">(</span><span class="s1">f</span><span class="s5">) </span><span class="s3">!= </span><span class="s2">&quot;[object Function]&quot; </span><span class="s3">&amp;&amp;</span>
        <span class="s1">Object</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">toString</span><span class="s3">.</span><span class="s1">call</span><span class="s5">(</span><span class="s1">f</span><span class="s5">) </span><span class="s3">!= </span><span class="s2">&quot;[object AsyncFunction]&quot;</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">throw Error</span><span class="s5">(</span><span class="s2">&quot;not a function&quot;</span><span class="s5">)</span><span class="s3">;</span>
    <span class="s4">}</span>
    <span class="s1">if </span><span class="s5">(</span><span class="s3">!</span><span class="s1">f</span><span class="s3">.</span><span class="s1">stub</span><span class="s5">) </span><span class="s4">{</span>
        <span class="s1">throw Error</span><span class="s5">(</span><span class="s2">&quot;not a mock function&quot;</span><span class="s5">)</span><span class="s3">;</span>
    <span class="s4">}</span>
    <span class="s1">return true</span><span class="s3">;</span>
<span class="s4">}</span>

<span class="s1">function when</span><span class="s5">(</span><span class="s1">f</span><span class="s5">) </span><span class="s4">{</span>
    <span class="s1">if </span><span class="s5">(</span><span class="s1">ifMockedFunction</span><span class="s5">(</span><span class="s1">f</span><span class="s5">)) </span><span class="s4">{</span>
        <span class="s1">return f</span><span class="s3">.</span><span class="s1">stub</span><span class="s3">.</span><span class="s1">bind</span><span class="s5">(</span><span class="s1">f</span><span class="s5">)</span><span class="s3">;</span>
    <span class="s4">}</span>
<span class="s4">}</span>

<span class="s1">export </span><span class="s4">{</span><span class="s1">MockKit</span><span class="s3">, </span><span class="s1">when</span><span class="s4">}</span><span class="s3">;</span></pre>
</body>
</html>